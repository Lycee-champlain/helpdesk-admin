<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Helpdesk - Lyc√©e Samuel de Champlain</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 3rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        
        .controls { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 30px 0;
            flex-wrap: wrap;
        }
        select, .btn { 
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        select { background: rgba(255,255,255,0.9); color: #333; }
        .btn { background: rgba(255,255,255,0.9); color: #667eea; font-weight: bold; }
        .btn:hover, select:hover { transform: translateY(-2px); }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 30px 0;
        }
        .stat-card { 
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { 
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .stat-label { 
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
        }
        
        .section { 
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section h2 { 
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .bar-chart { display: flex; gap: 10px; align-items: flex-end; height: 200px; margin: 20px 0; }
        .bar { 
            flex: 1;
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 5px;
            transition: all 0.3s;
        }
        .bar:hover { opacity: 0.8; }
        .bar-label { 
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #667eea;
        }
        
        .horizontal-bars .bar-item { 
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .horizontal-bars .bar-label { 
            width: 100px;
            text-align: right;
            font-size: 0.9rem;
        }
        .horizontal-bars .bar-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 30px;
            border-radius: 5px;
            transition: width 0.5s;
            position: relative;
        }
        .horizontal-bars .bar-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; }
        th { 
            background: #667eea;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        td { border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        
        .badge { 
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-ouvert { background: #fee; color: #c00; }
        .badge-encours { background: #ffeaa7; color: #d63031; }
        .badge-ferme { background: #e0e0e0; color: #666; }
        
        #loading { 
            text-align: center;
            padding: 100px 20px;
            font-size: 1.5rem;
        }
        .spinner { 
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error { 
            background: rgba(255,255,255,0.95);
            color: #c00;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        @media print {
            body { 
                background: white !important;
                color: black !important;
                padding: 0;
            }
            
            .container { max-width: 100%; }
            
            /* Masquer les contr√¥les */
            .controls { display: none !important; }
            
            /* En-t√™te rapport */
            header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 30px;
                margin: 0 0 30px 0;
                page-break-after: avoid;
            }
            
            h1 { 
                font-size: 2.5rem;
                text-shadow: none;
                color: white;
            }
            
            .subtitle { 
                color: rgba(255,255,255,0.95);
                font-size: 1rem;
            }
            
            /* Cartes statistiques */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin: 30px 0;
                page-break-inside: avoid;
            }
            
            .stat-card {
                background: white !important;
                color: black !important;
                border: 2px solid #667eea;
                box-shadow: none;
                page-break-inside: avoid;
            }
            
            .stat-value {
                color: #667eea !important;
                font-size: 2.5rem;
            }
            
            .stat-label {
                color: #333 !important;
                font-size: 0.85rem;
            }
            
            /* Sections */
            .section {
                background: white !important;
                color: black !important;
                border: 1px solid #ddd;
                box-shadow: none;
                margin: 30px 0;
                page-break-inside: avoid;
            }
            
            .section h2 {
                color: #667eea !important;
                font-size: 1.5rem;
                border-bottom: 3px solid #667eea;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
            
            /* Graphiques */
            .bar-chart, .horizontal-bars {
                page-break-inside: avoid;
            }
            
            .bar {
                background: linear-gradient(180deg, #667eea, #764ba2) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .bar-fill {
                background: linear-gradient(90deg, #667eea, #764ba2) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .bar-label, .bar-value {
                color: black !important;
            }
            
            .horizontal-bars .bar-value {
                color: white !important;
            }
            
            /* Tableau */
            table {
                page-break-inside: auto;
                border-collapse: collapse;
                width: 100%;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            th {
                background: #667eea !important;
                color: white !important;
                border: 1px solid #667eea;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            td {
                border: 1px solid #ddd;
                color: black !important;
            }
            
            tr:hover {
                background: white !important;
            }
            
            /* Badges */
            .badge {
                border: 1px solid currentColor;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .badge-ouvert {
                background: #fee !important;
                color: #c00 !important;
            }
            
            .badge-encours {
                background: #ffeaa7 !important;
                color: #d63031 !important;
            }
            
            .badge-ferme {
                background: #e0e0e0 !important;
                color: #666 !important;
            }
            
            /* Pied de page sur chaque page */
            @page {
                margin: 20mm;
                @bottom-right {
                    content: "Page " counter(page) " sur " counter(pages);
                    font-size: 9pt;
                    color: #666;
                }
                @bottom-left {
                    content: "Lyc√©e Samuel de Champlain - " attr(data-date);
                    font-size: 9pt;
                    color: #666;
                }
            }
            
            /* Date d'impression */
            header::after {
                content: "Rapport g√©n√©r√© le " attr(data-print-date);
                display: block;
                margin-top: 15px;
                font-size: 0.9rem;
                opacity: 0.8;
            }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Administration Helpdesk</h1>
            <p class="subtitle">Lyc√©e Samuel de Champlain - Acad√©mie de Cr√©teil</p>
            <p class="subtitle" style="font-size: 0.9rem; margin-top: 5px;">M. Bruno Grec & M. Saad Mechri</p>
        </header>

        <div id="loading">
            <div class="spinner"></div>
            <p>Chargement des donn√©es...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="controls">
                <select id="yearSelect" onchange="updateDashboard()">
                    <option value="all">üìä Toutes les donn√©es</option>
                    <option value="2025-2026">2025-2026</option>
                    <option value="2024-2025">2024-2025</option>
                </select>
                <button class="btn" onclick="printReport()">üñ®Ô∏è G√©n√©rer Rapport PDF</button>
                <button class="btn" onclick="loadData()">üîÑ Actualiser</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total">0</div>
                    <div class="stat-label">Total Incidents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ouvert">0</div>
                    <div class="stat-label">Ouverts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="encours">0</div>
                    <div class="stat-label">En Cours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ferme">0</div>
                    <div class="stat-label">Ferm√©s</div>
                </div>
            </div>

            <div class="section">
                <h2>üìà √âvolution Mensuelle</h2>
                <div id="monthlyChart" class="bar-chart"></div>
            </div>

            <div class="section">
                <h2>üè´ Top 10 Salles</h2>
                <div id="roomChart" class="horizontal-bars"></div>
            </div>

            <div class="section">
                <h2>üìã 20 Derniers Incidents</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Salle</th>
                            <th>Type</th>
                            <th>Auteur</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        var allData = [];
        var SHEET_ID = '1mC3doKLZpW3QdudQBF2Ni4aoxUQsyKY1Wv64BXuhK84';

        window.onload = function() {
            loadData();
        };

        function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            // URL pour acc√®s CSV public
            var url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/export?format=csv';
            
            fetch(url)
                .then(function(response) { return response.text(); })
                .then(function(csv) {
                    allData = parseCSV(csv);
                    console.log('Donn√©es charg√©es:', allData.length, 'incidents');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    updateDashboard();
                })
                .catch(function(error) {
                    console.error('Erreur:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').innerHTML = 
                        '<h2>‚ùå Erreur de chargement</h2>' +
                        '<p style="margin: 20px 0;">V√©rifiez que le Google Sheet est partag√© en lecture publique.</p>' +
                        '<p style="margin: 20px 0; font-size: 0.9rem;">' + error.message + '</p>' +
                        '<button class="btn" onclick="loadData()">üîÑ R√©essayer</button>';
                });
        }

        function parseCSV(csv) {
            var lines = csv.split('\n');
            if (lines.length < 2) return [];
            
            // Parser CSV robuste qui g√®re les guillemets et virgules
            function parseCSVLine(line) {
                var result = [];
                var current = '';
                var inQuotes = false;
                
                for (var i = 0; i < line.length; i++) {
                    var char = line[i];
                    var nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            var headers = parseCSVLine(lines[0]);
            var data = [];
            
            for (var i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                var values = parseCSVLine(lines[i]);
                var row = {};
                
                headers.forEach(function(header, index) {
                    row[header] = values[index] || '';
                });
                
                // Filtrer les lignes vides
                if (row.Horodateur && row.Horodateur.trim() !== '') {
                    data.push(row);
                }
            }
            
            return data;
        }

        function updateDashboard() {
            var year = document.getElementById('yearSelect').value;
            var data = year === 'all' ? allData : filterByYear(allData, year);
            
            var total = data.length;
            var ouvert = data.filter(function(r) { return r.Statut === 'Ouvert'; }).length;
            var encours = data.filter(function(r) { return r.Statut === 'En cours'; }).length;
            var ferme = data.filter(function(r) { return r.Statut === 'Ferm√©' || r.Statut === 'R√©solu'; }).length;

            document.getElementById('total').textContent = total;
            document.getElementById('ouvert').textContent = ouvert;
            document.getElementById('encours').textContent = encours;
            document.getElementById('ferme').textContent = ferme;

            createMonthlyChart(data);
            createRoomChart(data);
            updateTable(data);
        }

        function filterByYear(data, year) {
            var parts = year.split('-');
            var startYear = parseInt(parts[0]);
            var endYear = parseInt(parts[1]);
            return data.filter(function(row) {
                if (!row.Horodateur) return false;
                var date = new Date(row.Horodateur);
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                return (y === startYear && m >= 9) || (y === endYear && m <= 8);
            });
        }

        function createMonthlyChart(data) {
            var months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'];
            var counts = new Array(12).fill(0);
            
            data.forEach(function(row) {
                if (row.Horodateur) {
                    var m = new Date(row.Horodateur).getMonth();
                    counts[m]++;
                }
            });

            var max = Math.max.apply(null, counts) || 1;
            var html = '';
            
            months.forEach(function(month, i) {
                var height = (counts[i] / max * 100);
                html += '<div class="bar" style="height: ' + height + '%">' +
                        '<div class="bar-value">' + counts[i] + '</div>' +
                        '<div class="bar-label">' + month + '</div>' +
                        '</div>';
            });
            
            document.getElementById('monthlyChart').innerHTML = html;
        }

        function createRoomChart(data) {
            var rooms = {};
            data.forEach(function(row) {
                var room = row['Salle (Ex: F114)'] || row['Salle'] || 'Non sp√©cifi√©';
                if (room && room.trim()) {
                    rooms[room] = (rooms[room] || 0) + 1;
                }
            });

            console.log('Salles trouv√©es:', rooms);

            var sorted = Object.keys(rooms)
                .map(function(k) { return { room: k, count: rooms[k] }; })
                .sort(function(a, b) { return b.count - a.count; })
                .slice(0, 10);

            if (sorted.length === 0) {
                document.getElementById('roomChart').innerHTML = '<p style="text-align: center; color: #999;">Aucune salle trouv√©e</p>';
                return;
            }

            var max = sorted[0].count;
            var html = '';
            
            sorted.forEach(function(item) {
                var width = (item.count / max * 100);
                var roomName = item.room.length > 15 ? item.room.substring(0, 15) + '...' : item.room;
                html += '<div class="bar-item">' +
                        '<div class="bar-label" title="' + item.room + '">' + roomName + '</div>' +
                        '<div class="bar-fill" style="width: ' + width + '%">' +
                        '<div class="bar-value">' + item.count + '</div>' +
                        '</div>' +
                        '</div>';
            });
            
            document.getElementById('roomChart').innerHTML = html;
        }

        function printReport() {
            // Ajouter la date d'impression
            var now = new Date();
            var dateStr = now.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.querySelector('header').setAttribute('data-print-date', dateStr);
            
            // Ouvrir la bo√Æte de dialogue d'impression
            window.print();
        }

        function updateTable(data) {
            var tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.slice(-20).reverse().forEach(function(row) {
                var tr = document.createElement('tr');
                var date = row.Horodateur ? new Date(row.Horodateur).toLocaleDateString('fr-FR') : '-';
                var statut = row.Statut || 'Ouvert';
                var badgeClass = statut === 'Ouvert' ? 'badge-ouvert' : 
                                 statut === 'En cours' ? 'badge-encours' : 'badge-ferme';
                
                tr.innerHTML = 
                    '<td>' + date + '</td>' +
                    '<td>' + (row['Salle (Ex: F114)'] || '-') + '</td>' +
                    '<td>' + (row['Type de demande'] || '-') + '</td>' +
                    '<td>' + (row['Auteur de la demande (Nom et Pr√©nom)'] || '-') + '</td>' +
                    '<td><span class="badge ' + badgeClass + '">' + statut + '</span></td>';
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
